Here is the SQL code to create the 'calculate_weekly_stats' function in your Supabase database:

```sql
CREATE OR REPLACE FUNCTION public.calculate_weekly_stats(fail_threshold INT)
RETURNS VOID
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
BEGIN
  -- 1. Calculate Total Points per Week
  WITH weekly_scores AS (
    SELECT
      username,
      date_trunc('week', timestamp) as week_start,
      SUM(points) as total_points
    FROM
      heart_rate_data
    GROUP BY
      username,
      date_trunc('week', timestamp)
  ),

  -- 2. Logic for FAILS: Uses the 'fail_threshold' variable
  fails_calc AS (
    SELECT
      username,
      COUNT(*) as fail_count
    FROM
      weekly_scores
    WHERE
      total_points < fail_threshold
    GROUP BY
      username
  ),

  -- 3. Logic for COINS: Top scorer of the week
  weekly_winners AS (
    SELECT DISTINCT ON (week_start)
      week_start,
      username,
      total_points
    FROM
      weekly_scores
    ORDER BY
      week_start, total_points DESC
  ),

  coins_calc AS (
    SELECT
      username,
      COUNT(*) as coin_count
    FROM
      weekly_winners
    GROUP BY
      username
  )

  -- 4. Update the stats table
  INSERT INTO leaderboard_stats (username, fails, coins, updated_at)
  SELECT
    u.username,
    COALESCE(f.fail_count, 0),
    COALESCE(c.coin_count, 0),
    NOW()
  FROM
    (SELECT DISTINCT username FROM heart_rate_data) u
  LEFT JOIN fails_calc f ON u.username = f.username
  LEFT JOIN coins_calc c ON u.username = c.username
  ON CONFLICT (username) DO UPDATE
  SET
    fails = EXCLUDED.fails,
    coins = EXCLUDED.coins,
    updated_at = NOW();

END;
$$;
```

**Instructions to the user:**
1. Go to your Supabase project dashboard.
2. Navigate to the 'SQL Editor' section.
3. Paste the above SQL code into the editor.
4. Execute the query.

This will create or replace the `public.calculate_weekly_stats` function, allowing your application to call it with the `fail_threshold` parameter. After executing this, you can try running your application again.
