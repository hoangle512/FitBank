CREATE TABLE IF NOT EXISTS users (
  username VARCHAR(255) PRIMARY KEY, -- Changed from id to username
  display_name VARCHAR(255),
  avatar TEXT -- Assuming an avatar column exists in users table
);

CREATE TABLE IF NOT EXISTS heart_rate_data (
  id SERIAL PRIMARY KEY,
  username VARCHAR(255),
  bpm INT NOT NULL,
  timestamp TIMESTAMPTZ NOT NULL,
  points INT NOT NULL DEFAULT 0,
  UNIQUE (username, timestamp)
);

CREATE TABLE IF NOT EXISTS app_settings (
  key VARCHAR(255) PRIMARY KEY,
  value VARCHAR(255)
);

CREATE TABLE IF NOT EXISTS leaderboard_stats (
  username VARCHAR(255) PRIMARY KEY,
  coins INT DEFAULT 0,
  fails INT DEFAULT 0
);

CREATE OR REPLACE FUNCTION get_weekly_standings()
RETURNS TABLE(username text, score bigint, avatar text)
LANGUAGE plpgsql
AS $$
BEGIN
    RETURN QUERY
    SELECT
        hr.username,
        SUM(hr.points)::bigint as score,
        u.avatar::text
    FROM
        heart_rate_data hr
    JOIN
        users u ON hr.username = u.username
    WHERE
        hr.timestamp >= date_trunc('week', CURRENT_TIMESTAMP)
    GROUP BY
        hr.username, u.avatar
    ORDER BY
        score DESC;
END;
$$;
